<?php
require_once("util.php");

$CRID = getint("crid",crid_default());
$CID = getint("cid",0);

head_section("CorEx Browser");
?>
<table width='100%' height='100%' cellpadding=0 cellspacing=0 
		style="border-color:#0088cc;border-style:solid;border-width:1px 1px 2px 1px" >
	<tr>
		<td width='100%' height='20' align=left colspan=2>
			<table  cellpadding=0 cellspacing=0 width=100% style="background-color:#f5f5f5; 
					border-color:#0088cc;border-style:solid;border-width:1px 1px 2px 1px" >
				<tr>
					<td align=left style="cursor:pointer" onclick="location.href='/'">
							<!--span class='logotext'>CorEx<span style='color:#cc6666'>plorer</span></span-->
						<img src="/logo.png">
					</td>
					<td style="padding-left:20px" align=left>
						<table cellspacing=0 cellpadding=0>
							<tr>
								<td align="left">
						Dataset: <?php print run_sel("crid",$CRID) ?>
								</td>
							</tr>
							<tr>
								<td align="right">  
						<a href="/index.html?opt=dset&crid=<?php echo $CRID; ?>" 
							style="font-size:.9em" target="_blank">
								dataset overview</a>
								</td>
							</tr>
						</table>
					</td>
					<td style="padding-right:50px" align=right>
						Frame1: <?php print frame_sel(1,1) ?> <b>&nbsp;&nbsp;</b>
						Frame2: <?php print frame_sel(2,2) ?> <b>&nbsp;&nbsp;</b>
						Frame3: <?php print frame_sel(3,4) ?>
					</td>
				</tr>
			</table>
		</td>
	</tr>
	<tr>
		<td rowspan=2 width='60%' >
<iframe id="frame1" width='100%' height='100%' 
		src='/frame.php?ft=graph&fn=1&crid=<?php echo $CRID ?>&cid=<?php echo $CID ?>' 
	style=' border:1px solid #0088cc'></iframe>
		</td>
		<td width='40%'>
<iframe id="frame2" width='100%' height='100%' 
		src='/frame.php?ft=heatmap&fn=2&crid=<?php echo $CRID ?>&cid=<?php echo $CID ?>'
	style=' border:1px solid #0088cc'></iframe>
		</td>
	</tr>
	<tr>
		<td width='40%'>
<iframe id="frame3" width='100%' height='100%' 
		src='/frame.php?ft=survival&fn=3&crid=<?php echo $CRID ?>&cid=<?php echo $CID ?>'
	style=' border:1px solid #0088cc'></iframe>
		</td>
	</tr>
</table>
<script>
<?php 
	print_js_cluster_array();
?>
window.addEventListener("message", receiveMessage, false);
function receiveMessage(event)
{
	var lbl = event.data;
	var cid = lbl2cid[lbl];
	$('#frame2').contents().find('#sel_cid').val(cid);
	$('#frame2').contents().find('#sel_cid').closest('form').submit();;
	$('#frame3').contents().find('#sel_cid').val(cid);
	$('#frame3').contents().find('#sel_cid').closest('form').submit();;
}
function change_iframe(fnum,val) 
{
    var $iframe = $("#frame" + fnum );
	var cid = $iframe.contents().find('#sel_cid').val();
	//alert("keep cid=" +  cid);
	var url = "/frame.php?ft=" + val + "&crid=<?php echo $CRID ?>";
	if (cid != 0)
	{
		url += "&cid=" + cid;
	}
    if ( $iframe.length ) 
	{
        $iframe.attr("src",url);   
        return false;
    }
    return true;
}
var ftypes = ["","graph","heatmap","ppi","survival","annotation","genelist"];
$('#frame_sel1').change(function() 
{
	var newval = this.value;
	change_iframe(1,ftypes[newval]);	
});
$('#frame_sel2').change(function() 
{
	var newval = this.value;
	change_iframe(2,ftypes[newval]);	
});
$('#frame_sel3').change(function() 
{
	var newval = this.value;
	var lbl = ftypes[newval];	
	//alert("change frame 3 to " + lbl);
	change_iframe(3,lbl);	
});
$('#sel_crid').change(function() 
{
	var new_crid = this.value;
	location.href = "/explorer.html?crid=" + new_crid;
});
</script>

<?php

###########################################################################

function print_js_cluster_array()
{
	global $CRID,$DB;
	
	print "var lbl2cid = new Array();\n";
	$st = $DB->prepare("select id,lbl from clst where crid=? and lvl=0");
	$st->bind_param("i",$CRID);
	$st->bind_result($cid,$lbl);
	$st->execute();	
	while ($st->fetch())
	{
		print "lbl2cid['L1_$lbl']=$cid;\n";	
	}
	$st->close();
}

###########################################################################

function frame_sel($fnum, $defnum)
{
	$lbls = array("--choose--","graph","heatmap","ppi","survival","annotation","genelist");
	
	for ($val = 0; $val < count($lbls); $val++)
	{
		$lbl = $lbls[$val];
		$selected = ($val == $defnum ? " selected " : "");
		$opts[] = "<option $selected value='$val'>$lbl</option>";
	}
	$id = "frame_sel$fnum";
	return "<select id='$id' autocomplete='off'>\n".implode("\n",$opts)."</select>\n";

}
?>
