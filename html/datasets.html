<?php
require_once("util.php");

$CRID = getint("crid",0);
?>
<head>
<link rel="stylesheet" href="http://www.canvasxpress.org/css/canvasXpress.css" type="text/css"/>
<script type="text/javascript" src="http://www.canvasxpress.org/js/canvasXpress.min.js"></script>
<script>
function toggle_params()
{
	$("#params").toggle();	
}
</script>
</head>
<div style="padding:10px 10px 0px 10px">

<?php
if ($CRID == 0)
{
	echo <<<END
<h4>Datasets</h4>

<form>
<input type="hidden" name="opt" value="dset">
<input type="hidden" name="crid" id="inp_crid" value="$CRID">
<table rules=all border=1 cellpadding=3>
	<tr>
		<td>Run</td>
		<td>#Samples</td>
		<td>#Genes</td>
		<td>Date Loaded</td>
	</tr>
END;


$ngenes = array();
$nsamps = array();
$nsurv = array();


$st = dbps("select glists.id,count(*) ".
		" from glists join glist on glist.glid=glists.id ".
		" group by glists.id");
$st->bind_result($id,$num);
$st->execute();
while ($st->fetch())
{
	$ngenes[$id] = $num;
}
$st->close();

$st = dbps("select dset.id,count(*) ".
		" from samp join dset on dset.id=samp.dsid ".
		" group by dset.id");
$st->bind_result($id,$num);
$st->execute();
while ($st->fetch())
{
	$nsamps[$id] = $num;
}	
$st->close();

$st = dbps("select samp.dsid,count(*) ".
		" from sampdt join samp on samp.id=sampdt.sid where dtd <= 0 ".
		" group by samp.dsid");
$st->bind_result($dsid,$num);
$st->execute();
while ($st->fetch())
{
	$nsurv[$dsid] = $num;
}	
$st->close();


$st = dbps("select id,glid,dsid,lbl,meth,date_format(load_dt,'%b %d %Y') from clr");
$st->bind_result($crid,$glid,$dsid,$lbl,$meth,$date);
$st->execute();
while ($st->fetch())
{
	$ngene = $ngenes[$glid];
	$nsamp = $nsamps[$dsid];
	$nsrv = $nsurv[$dsid];

	$pctsrv = floor((100*$nsrv)/$nsamp);

	echo <<<END
	<tr>
		<td><a href="javascript:form_submit($crid);">$lbl</a></td>
		<td>$nsamp</td>
		<td>$ngene</td>
		<td>$date</td>
	</tr>
END;
}
$st->close();

echo <<<END
</table>
</form>
<a href="/tc.php">Compare Total Correlations</a>
</div>
<script>
function form_submit(crid)
{
	$("#inp_crid").val(crid);
 	$("#inp_crid").closest('form').submit();	
}
</script>
END;

} ## end CRID != 0

if ($CRID != 0)
{
	load_proj_data($data,$CRID);
	$lbl = $data["lbl"];
	$descr = trim($data["descr"]);
	$ref = trim($data["ref"]);
	$param = trim($data["param"]);

	$descr = preg_replace("/\n/","<p>",$descr);
	
	echo <<<END
<table cellspacing=0 cellpadding=0>
	<tr>
		<td>
<h4> Dataset: $lbl </h4>
		</td>
		<td style="padding-left:100px">
<a href="/explorer.html?crid=$CRID">Explore this dataset</a>
		</td>
	</tr>
</table>

<p>$descr<p>

END;

	if ($ref != "")
	{
		echo <<<END
<b>Reference:</b><br>$ref
END;
	}
	survival_graph($CRID);
	if ($param != "")
	{
		echo <<<END
<div style="margin-top:40px;">
<a href="javascript:toggle_params();">Show CorEx run parameters</a><p>
<div id="params" style="display:none">
<table rules=all border=true cellpadding=3>
END;
		$json = json_decode($param)->{'0'};
		foreach ($json as $name => $val)
		{
			print "<tr><td>$name</td><td>$val</td></tr>\n";
		}
	echo <<<END
</table>
</div>
</div>
END;

	}


}
function survival_graph($CRID)
{
	# Line graph: one variable, samples = times of events
	$graph_vars = "";
	$graph_samps = "";
	$graph_data = "";

	$this_survp = 0;

	$data = array(1.0);   # survival for each timepoint

	$st = dbps("select dte,surv from survdt_ov where crid=? order by dte asc");
	$st->bind_param("i",$CRID);
	$st->bind_result($time,$surv);
	$st->execute();
	$prev_time = 0;
	while ($st->fetch())
	{
		$data[$time] = $surv;
		$prev_time = $time;
	}
	$st->close();
	$max_time = $prev_time;

	if (count($data) == 1)
	{
		return;
	}
	
	# fill in missing times
	for ($t = 0; $t <= $max_time; $t++)
	{
		if (!isset($data[$t]))
		{
			$data[$t] = $data[$t-1];
		}
	}
	
	$samps = array();	
	for ($t = 0; $t <= $max_time; $t++)
	{
		if (isset($data[$t]))
		{
			$months = $t/30.0;
			$samps[] = "\"$months\"";
		}
	}
	$sampstr = "[".implode(",\n",$samps)."]";

	ksort($data, SORT_NUMERIC);
	$datastr = "[[".implode(",\n",$data)."]]";
	$varstr = "[\"Survival\"]";
	
	echo <<<END

		<canvas  id="canvasId" width="650" height="450" style="border:1px solid black;"></canvas>
	<script>
	var data = {"y": {"vars": $varstr,
					  "smps": $sampstr,
					  "data": $datastr
					 }
				};
	var conf = {"graphType": "Line",
				"lineDecoration" : false,
				"smpLabelInterval" : 300,
				"smpTitle" : "Months",
				"graphOrientation" : "vertical"
				};                 
	var cX = new CanvasXpress("canvasId", data, conf);
	</script>
END;

}


?>




