<?php
require_once("util.php");

$CRID = getint("crid",0);
?>
<div style="padding:10px 10px 0px 10px">

<h4>Datasets</h4>

<form>
<input type="hidden" name="opt" value="dset">
<input type="hidden" name="crid" id="inp_crid" value="<?php echo $CRID ?>">
<table rules=all border=1 cellpadding=3>
	<tr>
		<td>Run</td>
		<td>#Samples</td>
		<td>#Genes</td>
		<td>Survival</td>
		<td>Date Loaded</td>
	</tr>
<?php

$ngenes = array();
$nsamps = array();
$nsurv = array();


$st = dbps("select glists.id,count(*) ".
		" from glists join glist on glist.glid=glists.id ".
		" group by glists.id");
$st->bind_result($id,$num);
$st->execute();
while ($st->fetch())
{
	$ngenes[$id] = $num;
}
$st->close();

$st = dbps("select dset.id,count(*) ".
		" from samp join dset on dset.id=samp.dsid ".
		" group by dset.id");
$st->bind_result($id,$num);
$st->execute();
while ($st->fetch())
{
	$nsamps[$id] = $num;
}	
$st->close();

$st = dbps("select samp.dsid,count(*) ".
		" from sampdt join samp on samp.id=sampdt.sid where dtd >= 0 ".
		" group by samp.dsid");
$st->bind_result($dsid,$num);
$st->execute();
while ($st->fetch())
{
	$nsurv[$dsid] = $num;
}	
$st->close();


$st = dbps("select id,glid,dsid,lbl,meth,date_format(load_dt,'%b %d %Y') from clr");
$st->bind_result($crid,$glid,$dsid,$lbl,$meth,$date);
$st->execute();
while ($st->fetch())
{
	$ngene = $ngenes[$glid];
	$nsamp = $nsamps[$dsid];
	$nsrv = $nsurv[$dsid];

	$pctsrv = floor((100*$nsrv)/$nsamp);

	echo <<<END
	<tr>
		<td><a href="javascript:form_submit($crid);">$lbl</a></td>
		<td>$nsamp</td>
		<td>$ngene</td>
		<td>$pctsrv%</td>
		<td>$date</td>
	</tr>
END;
}
$st->close();
?>
</table>
</form>
</div>
<script>
function form_submit(crid)
{
	$("#inp_crid").val(crid);
 	$("#inp_crid").closest('form').submit();	
}
</script>
<?php

if ($CRID != 0)
{
	load_proj_data($data,$CRID);
	$lbl = $data["lbl"];
	$descr = $data["descr"];
	
	echo <<<END
<h4> Dataset: $lbl </h4>
<p>$descr<p>
<a href="/explorer.html?crid=$CRID">Explore this dataset</a>
END;

}

?>




